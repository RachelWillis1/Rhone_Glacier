name: "Build and push to ECR"

on: 
  push: 
    branches: [ "main" ]
jobs:
  BuildAndPushImageToECR:
    name: "Build and Push to ECR"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Make the script files executable
        run: chmod +x app/scripts-main/job.sh

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ASIA6FXGX4FDEZ3FJZJR
          aws-secret-access-key: fmkUFrhVVnkfZIutUyMB3b19qCkSaoVIIQrvw5+I
          aws-session-token: IQoJb3JpZ2luX2VjELH//////////wEaCXVzLWVhc3QtMiJIMEYCIQDbXJeMOAWB2JeYAhe/95khDr/gvJgmxSWHrJPKaE6qTAIhAPX/eVDGO294DCR+34Hh2isifqTOUQkPRCSLrENWmVbKKowDCKr//////////wEQAxoMOTc0MzY3NzQ0MzI2Igwf0u5L5QZV8bZeEjkq4AIRRe+h3PXwUIBlLhEni1bhWzhEteTM0z6y42d1ZjERZ0EBKL1Dvz5+PMA47X18Lk6x++zXho9lk1e573ddUj6Doepj2ZWs7fTsFbL1KJQ4D3cKqt7hkDFsg3nzZqhpgT/BAvGDgG+9DdjhB1300zuPFh+5x7pTKirZ4CdSYF9fwR+OPeLmwReTnQ2glRK9Aob6g/hzbhBJnHLBgfZUopzn8XL6zIVFEEXRD0GtV2ub723dTuY2o1Ki++IAj7Wh49+9lDzaTe6doGBC9a7E0gl6y294xNkCw6kZ71beHaZXD72EhWQ1WwkoQLF2RvgjNgAEEB10NHI22VZJIbW/4hQVyHt5WRVMJL4m5Ntph4TvonKx0AO5tjO8N/I0jPqjFWNy4VWbmOU2N7LWAkje2sJROzZmlAWkI/Ah7PeME9mAd78Jcos/b8jyUbKdYgamB2IcTP5eT2W9+JO9SiyE4ZwbMKjc1qgGOqUB+dhPHXGwlcbtid7HGFtUF4qy8GE5VoFKCnRzRQs37p3AM3UYGmBzz20yEAOEQc3qoYgrAnC0FHJdDO1DKK7fUSjZ+Vto4h0aLWBnbgP3rwhfkb58bDtr8DPDvG5oyImslNDn0t/x1f9iEXY32a0MpIwOblMQpeDBAelYarbGTwjmzXyl4Q+V00P5jXss86QGikR+m1qVnRBRRa9iEBj3ZovFu1wC
          aws-region: us-east-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: "rhone_glacier"
          IMAGE_TAG: v1
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "::set-output name=image::$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
