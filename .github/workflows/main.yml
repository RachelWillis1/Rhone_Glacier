name: "Build and push to ECR"

on: 
  push: 
    branches: [ "main" ]
jobs:
  BuildAndPushImageToECR:
    name: "Build and Push to ECR"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Make the script files executable
        run: chmod +x app/scripts-main/job.sh

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ASIA6FXGX4FDFU2RNAHB
          aws-secret-access-key: MMDERUTUn4qUkhHvLHyB3Y+JjmwKwV3DHwp5svKW
          aws-session-token: IQoJb3JpZ2luX2VjEJr//////////wEaCXVzLWVhc3QtMiJHMEUCIQD2kujCcjvb6RSWsN/QFgOsKzn9DFE1CwL/j6be269TdAIgf+WRu/lE+AVkAZAEZQmofxjRwqNk/cIULsUmAzksl1wqjAMIk///////////ARADGgw5NzQzNjc3NDQzMjYiDAbjVPJ1qeWC1z73FSrgAvAPWjSn52jSYTz0VvEV5JiMCJTh1QVWhsAkH2XeawWNCWFHH5kNvg3TxEWEbqyhtLS6QfNjpmhzCBV5wuzKsfMopiv8zyPA7lpBtR8IvA2OCbKnb0t8O9g1DX7B00quOsGgYsDjTByW+N39iQbHaLSPolslblW8k2lSa4uWWLJPfqnue4tiiV/6d0RQ1kVBK2znObkkQSom57w2YQZ7D6t7ZkMxvCcX3DOl+Z6N1TpDBcMp+mm0o7neAVcnDc4wzL6Pd5CnELq/AshLSRBTV8xl7lHZucO0BfGiAlbkYmKt9JO/goEfchnNiCkMpBB84/TJf4wjcO5nRBBA1u+ieL83T97XYrBIZZEOsLO/fxQCODPZcyEctCBi/RMrG2/DpTmontl7qWyUFcgT08D7fl4tPZl38m2Mx6Wg0IOgeBPusJxfc83xjTKXfrR1BZd1q258dQhOpTRHavuSPlMwBsAwtt7RqAY6pgGAgLahLf0gpUnoFnFk65eGZKFhtSMEpeZx9S4/qgppiEKs9cNjb0ZaaPKaMqzPY9vgvUh6WD7unYjiTMn4Uyy7Hai0Q+B0yhHyvIT9seAekgAt2fVS63BUFF6xIHPUi78c7PK9+Y1l65hyt62AsiyWicBxWh2g6ukFiTtuNBikJN266jQKgRexaOxDUR1sXPyx2UdXWr32HaMHMeItG1u/443SRGbK
          aws-region: us-east-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: "rhone_glacier"
          IMAGE_TAG: v1
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "::set-output name=image::$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
